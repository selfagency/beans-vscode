FROM mcr.microsoft.com/devcontainers/typescript-node:22

# Install Go from official source with architecture detection and checksum verification
RUN ARCH=$(uname -m) && \
    if [ "$ARCH" = "x86_64" ]; then \
        GOARCH="amd64"; \
        EXPECTED_SHA256="cbcad4a6482107c7c7926df1608106c189417163428200ce357695cc7e01d091"; \
    elif [ "$ARCH" = "aarch64" ]; then \
        GOARCH="arm64"; \
        EXPECTED_SHA256="47c84d332123883653b70da2db7dd57d2a865921ba4724efcdf56b5da7021db0"; \
    else \
        echo "Unsupported architecture: $ARCH" && exit 1; \
    fi && \
    apt-get update && apt-get install -y curl jq git wget && \
    wget -q https://go.dev/dl/go1.23.5.linux-${GOARCH}.tar.gz && \
    echo "$EXPECTED_SHA256  go1.23.5.linux-${GOARCH}.tar.gz" | sha256sum -c - && \
    tar -C /usr/local -xzf go1.23.5.linux-${GOARCH}.tar.gz && \
    rm go1.23.5.linux-${GOARCH}.tar.gz && \
    rm -rf /var/lib/apt/lists/*

ENV PATH="/usr/local/go/bin:/root/go/bin:${PATH}"

# Install beans CLI (pinned version for reproducible tests)
RUN go install github.com/hmans/beans@v0.13.2

# Verify beans installed
RUN beans version

# Set up workspace
WORKDIR /workspace
RUN git config --global user.email "test@example.com" && \
    git config --global user.name "Test User" && \
    git config --global init.defaultBranch main

# Copy extension and test files
COPY . /workspace/

CMD ["/bin/bash"]
