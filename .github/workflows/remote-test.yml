name: Remote Compatibility Tests

on:
  push:
    branches: [main]
    paths:
      - "src/**"
  pull_request:
    branches: [main]
    paths:
      - "src/**"
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: read
  packages: write

concurrency:
  group: remote-tests-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  docker-remote-test:
    name: Docker Remote Test
    runs-on: ubuntu-latest
    timeout-minutes: 20

    strategy:
      fail-fast: false
      matrix:
        include:
          - node-version: "20"
            base-image: "node:20-alpine"
          - node-version: "22"
            base-image: "node:22-bookworm"

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Compile extension
        run: pnpm run compile

      - name: Package extension
        run: |
          pnpm install -g @vscode/vsce
          vsce package --no-dependencies --out beans-vscode-test.vsix

      - name: Create Dockerfile for testing
        run: |
          cat > Dockerfile.test << 'EOF'
          FROM ${{ matrix.base-image }}

          # Install Go from official source (distro packages are often too old)
          RUN if command -v apt-get > /dev/null; then \
                apt-get update && apt-get install -y curl jq git wget && \
                wget -q https://go.dev/dl/go1.23.5.linux-amd64.tar.gz && \
                tar -C /usr/local -xzf go1.23.5.linux-amd64.tar.gz && \
                rm go1.23.5.linux-amd64.tar.gz; \
              elif command -v apk > /dev/null; then \
                apk add --no-cache curl jq git bash wget && \
                wget -q https://go.dev/dl/go1.23.5.linux-amd64.tar.gz && \
                tar -C /usr/local -xzf go1.23.5.linux-amd64.tar.gz && \
                rm go1.23.5.linux-amd64.tar.gz; \
              fi

          ENV PATH="/usr/local/go/bin:/root/go/bin:${PATH}"

          # Install beans CLI
          RUN go install github.com/hmans/beans@latest

          # Verify beans installed
          RUN beans version

          # Set up workspace
          WORKDIR /workspace
          RUN git config --global user.email "test@example.com" && \
              git config --global user.name "Test User"

          # Copy extension for testing
          COPY . /workspace/

          EOF

      - name: Build test image
        run: docker build -t beans-vscode-remote-test -f Dockerfile.test .

      - name: Run remote compatibility tests
        run: |
          docker run --rm beans-vscode-remote-test /bin/bash -c '
            set -e

            echo "=== Testing Beans CLI ==="
            beans version

            echo ""
            echo "=== Creating clean test directory ==="
            mkdir -p /tmp/beans-test
            cd /tmp/beans-test

            echo ""
            echo "=== Initializing Beans workspace ==="
            beans init

            echo ""
            echo "=== Creating test beans ==="
            beans create "Test Issue 1" -t task -s todo -d "Test description"
            beans create "Test Bug" -t bug -s in-progress -p high
            beans create "Test Feature" -t feature -s draft

            echo ""
            echo "=== Listing beans ==="
            BEAN_COUNT=$(beans list --json | jq "length")
            echo "Found $BEAN_COUNT beans"

            if [ "$BEAN_COUNT" -ne 3 ]; then
              echo "ERROR: Expected 3 beans, found $BEAN_COUNT"
              exit 1
            fi

            echo ""
            echo "=== Testing bean operations ==="
            FIRST_BEAN=$(beans list --json | jq -r ".[0].id")
            echo "Testing with bean: $FIRST_BEAN"

            beans show "$FIRST_BEAN" --json | jq .
            beans update "$FIRST_BEAN" -s completed

            STATUS=$(beans show "$FIRST_BEAN" --json | jq -r ".status")
            if [ "$STATUS" != "completed" ]; then
              echo "ERROR: Bean status should be completed, got $STATUS"
              exit 1
            fi

            echo ""
            echo "=== Testing GraphQL query ==="
            beans query "{ beans { id title status type } }" --json | jq .

            echo ""
            echo "✅ All remote compatibility tests passed!"
          '

      - name: Upload test artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: remote-test-logs-${{ matrix.base-image }}-node${{ matrix.node-version }}
          path: |
            *.log
            .beans/

  devcontainer-test:
    name: Dev Container Test
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Compile extension
        run: pnpm run compile

      - name: Create test devcontainer config
        run: |
          mkdir -p .devcontainer-test
          cat > .devcontainer-test/devcontainer.json << 'EOF'
          {
            "name": "Beans Remote Test",
            "image": "mcr.microsoft.com/devcontainers/typescript-node:22",
            "features": {
              "ghcr.io/devcontainers/features/go:1": {
                "version": "latest"
              }
            },
            "postCreateCommand": "echo Devcontainer created",
            "customizations": {
              "vscode": {
                "settings": {
                  "beans.ai.enabled": true,
                  "beans.logging.level": "debug"
                }
              }
            }
          }
          EOF

      - name: Login to GHCR
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Push image to GHCR for caching (non-PR builds only)
      # Note: devcontainers/ci@v0.3 'push' parameter accepts 'always', 'never', or 'filter' (not boolean values)
      - name: Test devcontainer build (push image)
        if: github.event_name != 'pull_request'
        uses: devcontainers/ci@v0.3
        with:
          configFile: .devcontainer-test/devcontainer.json
          imageName: ghcr.io/${{ github.repository_owner }}/beans-vscode-devcontainer-test
          cacheFrom: ghcr.io/${{ github.repository_owner }}/beans-vscode-devcontainer-test
          push: always
          runCmd: |
            export GIT_TERMINAL_PROMPT=0
            export GOPROXY=https://proxy.golang.org,direct
            export GOSUMDB=sum.golang.org

            if ! command -v beans >/dev/null 2>&1; then
              echo "=== Installing beans CLI (proxy-first, non-interactive) ==="
              if ! go install github.com/hmans/beans@latest; then
                echo "Primary install failed; retrying with proxy-only mode"
                export GOPROXY=https://proxy.golang.org
                go install github.com/hmans/beans@latest
              fi
            fi

            echo "=== Checking beans installation ==="
            beans version

            echo ""
            echo "=== Creating clean test directory ==="
            mkdir -p /tmp/beans-test
            cd /tmp/beans-test
            beans init

            echo ""
            echo "=== Verifying workspace initialized ==="
            if [ ! -f ".beans.yml" ]; then
              echo "ERROR: .beans.yml not found"
              exit 1
            fi

            echo ""
            echo "=== Creating and listing beans ==="
            beans create "DevContainer Test" -t task -s todo
            beans list --json | jq .

            echo ""
            echo "✅ DevContainer test passed!"

      # PR builds: no push, no cache (avoid 403 on private GHCR images)
      # Note: push parameter accepts 'always', 'never', or 'filter' values
      - name: Test devcontainer build (no push)
        if: github.event_name == 'pull_request'
        uses: devcontainers/ci@v0.3
        with:
          configFile: .devcontainer-test/devcontainer.json
          imageName: ghcr.io/${{ github.repository_owner }}/beans-vscode-devcontainer-test
          push: never
          runCmd: |
            export GIT_TERMINAL_PROMPT=0
            export GOPROXY=https://proxy.golang.org,direct
            export GOSUMDB=sum.golang.org

            if ! command -v beans >/dev/null 2>&1; then
              echo "=== Installing beans CLI (proxy-first, non-interactive) ==="
              if ! go install github.com/hmans/beans@latest; then
                echo "Primary install failed; retrying with proxy-only mode"
                export GOPROXY=https://proxy.golang.org
                go install github.com/hmans/beans@latest
              fi
            fi

            echo "=== Checking beans installation ==="
            beans version

            echo ""
            echo "=== Creating clean test directory ==="
            mkdir -p /tmp/beans-test
            cd /tmp/beans-test
            beans init

            echo ""
            echo "=== Verifying workspace initialized ==="
            if [ ! -f ".beans.yml" ]; then
              echo "ERROR: .beans.yml not found"
              exit 1
            fi

            echo ""
            echo "=== Creating and listing beans ==="
            beans create "DevContainer Test" -t task -s todo
            beans list --json | jq .

            echo ""
            echo "✅ DevContainer test passed!"

  # Optional: Test with actual VS Code in container
  vscode-integration-test:
    name: VS Code Remote Integration Test
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Compile and package
        run: |
          pnpm run compile
          pnpm install -g @vscode/vsce
          vsce package --no-dependencies

      - name: Verify extension package
        run: |
          echo "Extension packaged successfully for remote installation"
          ls -lh *.vsix

          # Verify the .vsix file was created
          if [ ! -f *.vsix ]; then
            echo "ERROR: Extension package not found"
            exit 1
          fi

          echo "✅ Extension can be packaged for remote deployment"

  summary:
    name: Remote Tests Summary
    runs-on: ubuntu-latest
    needs: [docker-remote-test, devcontainer-test, vscode-integration-test]
    if: always()

    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.docker-remote-test.result }}" != "success" ] || \
             [ "${{ needs.devcontainer-test.result }}" != "success" ] || \
             [ "${{ needs.vscode-integration-test.result }}" != "success" -a "${{ needs.vscode-integration-test.result }}" != "skipped" ]; then
            echo "❌ Some remote compatibility tests failed"
            exit 1
          fi
          echo "✅ All remote compatibility tests passed!"
