name: Remote Tests

on:
  push:
    branches: [main]
    paths:
      - "src/**"
      - "package.json"
      - "pnpm-lock.yaml"
  pull_request:
    branches: [main]
    paths:
      - "src/**"
      - "package.json"
      - "pnpm-lock.yaml"
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: read
  packages: write

concurrency:
  group: remote-tests-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      src: ${{ steps.filter.outputs.src }}
    steps:
      - uses: actions/checkout@v6
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            src:
              - 'src/**'

  remote-test:
    name: Remote Test (${{ matrix.os }})
    needs: changes
    if: needs.changes.outputs.src == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            node-version: "22"
          - os: windows-latest
            node-version: "22"

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}
          cache: "pnpm"

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24.x"
          cache: false

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
            ${{ runner.os == 'Windows' && '~\AppData\Local\go-build' || '~/.cache/go-build' }}
          key: go-${{ runner.os }}-1.24-${{ hashFiles('**/go.sum') || 'nochecksum' }}
          restore-keys: |
            go-${{ runner.os }}-1.24-
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Compile extension
        run: pnpm run compile

      - name: Package extension
        run: |
          pnpm install -g @vscode/vsce
          vsce package --no-dependencies --out beans-vscode-test.vsix

      - name: Install beans CLI
        run: go install github.com/hmans/beans@latest

      - name: Run remote compatibility tests
        shell: bash
        run: |
          set -e

          echo "=== Testing Beans CLI ==="
          beans version

          echo ""
          echo "=== Creating clean test directory ==="
          TEST_DIR="${{ runner.temp }}/beans-test"
          mkdir -p "$TEST_DIR"
          cd "$TEST_DIR"

          echo ""
          echo "=== Initializing Beans workspace ==="
          beans init

          echo ""
          echo "=== Creating test beans ==="
          beans create "Test Issue 1" -t task -s todo -d "Test description"
          beans create "Test Bug" -t bug -s in-progress -p high
          beans create "Test Feature" -t feature -s draft

          echo ""
          echo "=== Listing beans ==="
          RAW_OUTPUT=$(beans graphql --json "query ListBeans { beans { id } }" 2>&1) || true
          echo "DEBUG: Raw graphql output: $RAW_OUTPUT"
          BEAN_COUNT=$(echo "$RAW_OUTPUT" | jq ".beans | length")
          echo "Found $BEAN_COUNT beans"

          if [ "$BEAN_COUNT" -ne 3 ]; then
            echo "ERROR: Expected 3 beans, found $BEAN_COUNT"
            echo "DEBUG: .beans/ contents:"
            find .beans -name "*.md" -type f 2>/dev/null || echo "(no files)"
            exit 1
          fi

          echo ""
          echo "=== Testing bean operations ==="
          FIRST_BEAN=$(beans graphql --json "query ListBeans { beans { id } }" | jq -r ".beans[0].id")
          echo "Testing with bean: $FIRST_BEAN"

          beans graphql --json "query ShowBean(\$id: ID!) { bean(id: \$id) { id title status } }" --variables "{\"id\":\"$FIRST_BEAN\"}" | jq .
          beans graphql --json "mutation UpdateBean(\$id: ID!, \$input: UpdateBeanInput!) { updateBean(id: \$id, input: \$input) { id status } }" --variables "{\"id\":\"$FIRST_BEAN\",\"input\":{\"status\":\"completed\"}}"

          STATUS=$(beans graphql --json "query ShowBean(\$id: ID!) { bean(id: \$id) { status } }" --variables "{\"id\":\"$FIRST_BEAN\"}" | jq -r ".bean.status")
          if [ "$STATUS" != "completed" ]; then
            echo "ERROR: Bean status should be completed, got $STATUS"
            exit 1
          fi

          echo ""
          echo "=== Testing GraphQL query ==="
          beans graphql --json "query ListBeans { beans { id title status type } }" | jq .

          echo ""
          echo "✅ All remote compatibility tests passed!"

      - name: Upload test artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: remote-test-logs-${{ matrix.os }}-node${{ matrix.node-version }}
          path: |
            *.log
            .beans/

  devcontainer-test:
    name: Dev Container Test
    needs: changes
    if: needs.changes.outputs.src == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Compile extension
        run: pnpm run compile

      - name: Create test devcontainer config
        run: |
          mkdir -p .devcontainer-test
          cat > .devcontainer-test/devcontainer.json << 'EOF'
          {
            "name": "Beans Remote Test",
            "image": "mcr.microsoft.com/devcontainers/typescript-node:22",
            "features": {
              "ghcr.io/devcontainers/features/go:1": {
                "version": "latest"
              }
            },
            "postCreateCommand": "echo Devcontainer created",
            "customizations": {
              "vscode": {
                "settings": {
                  "beans.ai.enabled": true,
                  "beans.logging.level": "debug"
                }
              }
            }
          }
          EOF

      - name: Login to GHCR
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Push image to GHCR for caching (non-PR builds only)
      # Note: devcontainers/ci@v0.3 'push' parameter accepts 'always', 'never', or 'filter' (not boolean values)
      - name: Test devcontainer build (push image)
        if: github.event_name != 'pull_request'
        uses: devcontainers/ci@v0.3
        with:
          configFile: .devcontainer-test/devcontainer.json
          imageName: ghcr.io/${{ github.repository_owner }}/beans-vscode-devcontainer-test
          cacheFrom: ghcr.io/${{ github.repository_owner }}/beans-vscode-devcontainer-test
          push: always
          runCmd: |
            export GIT_TERMINAL_PROMPT=0
            export GOPROXY=https://proxy.golang.org,direct
            export GOSUMDB=sum.golang.org

            if ! command -v beans >/dev/null 2>&1; then
              echo "=== Installing beans CLI (proxy-first, non-interactive) ==="
              if ! go install github.com/hmans/beans@latest; then
                echo "Primary install failed; retrying with proxy-only mode"
                export GOPROXY=https://proxy.golang.org
                go install github.com/hmans/beans@latest
              fi
            fi

            echo "=== Checking beans installation ==="
            beans version

            echo ""
            echo "=== Creating clean test directory ==="
            mkdir -p /tmp/beans-test
            cd /tmp/beans-test
            beans init

            echo ""
            echo "=== Verifying workspace initialized ==="
            if [ ! -f ".beans.yml" ]; then
              echo "ERROR: .beans.yml not found"
              exit 1
            fi

            echo ""
            echo "=== Creating and listing beans ==="
            beans graphql --json "mutation CreateBean(\$input: CreateBeanInput!) { createBean(input: \$input) { id } }" --variables '{"input":{"title":"DevContainer Test","type":"task","status":"todo"}}'
            beans graphql --json "query ListBeans { beans { id title } }" | jq .

            echo ""
            echo "✅ DevContainer test passed!"

      # PR builds: no push, no cache (avoid 403 on private GHCR images)
      # Note: push parameter accepts 'always', 'never', or 'filter' values
      - name: Test devcontainer build (no push)
        if: github.event_name == 'pull_request'
        uses: devcontainers/ci@v0.3
        with:
          configFile: .devcontainer-test/devcontainer.json
          imageName: ghcr.io/${{ github.repository_owner }}/beans-vscode-devcontainer-test
          push: never
          runCmd: |
            export GIT_TERMINAL_PROMPT=0
            export GOPROXY=https://proxy.golang.org,direct
            export GOSUMDB=sum.golang.org

            if ! command -v beans >/dev/null 2>&1; then
              echo "=== Installing beans CLI (proxy-first, non-interactive) ==="
              if ! go install github.com/hmans/beans@latest; then
                echo "Primary install failed; retrying with proxy-only mode"
                export GOPROXY=https://proxy.golang.org
                go install github.com/hmans/beans@latest
              fi
            fi

            echo "=== Checking beans installation ==="
            beans version

            echo ""
            echo "=== Creating clean test directory ==="
            mkdir -p /tmp/beans-test
            cd /tmp/beans-test
            beans init

            echo ""
            echo "=== Verifying workspace initialized ==="
            if [ ! -f ".beans.yml" ]; then
              echo "ERROR: .beans.yml not found"
              exit 1
            fi

            echo ""
            echo "=== Creating and listing beans ==="
            beans graphql --json "mutation CreateBean(\$input: CreateBeanInput!) { createBean(input: \$input) { id } }" --variables '{"input":{"title":"DevContainer Test","type":"task","status":"todo"}}'
            beans graphql --json "query ListBeans { beans { id title } }" | jq .

            echo ""
            echo "✅ DevContainer test passed!"

  # Optional: Test with actual VS Code in container
  vscode-integration-test:
    name: VS Code Remote Integration Test
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Compile and package
        run: |
          pnpm run compile
          pnpm install -g @vscode/vsce
          vsce package --no-dependencies

      - name: Verify extension package
        run: |
          echo "Extension packaged successfully for remote installation"
          ls -lh *.vsix

          # Verify the .vsix file was created
          if [ ! -f *.vsix ]; then
            echo "ERROR: Extension package not found"
            exit 1
          fi

          echo "✅ Extension can be packaged for remote deployment"

  summary:
    name: Remote Tests Summary
    runs-on: ubuntu-latest
    needs: [remote-test, devcontainer-test, vscode-integration-test]
    if: always()

    steps:
      - name: Check test results
        run: |
          fail=false
          for result in \
            "remote-test=${{ needs.remote-test.result }}" \
            "devcontainer-test=${{ needs.devcontainer-test.result }}" \
            "vscode-integration-test=${{ needs.vscode-integration-test.result }}"; do
            name="${result%%=*}"
            value="${result##*=}"
            if [[ "$value" == "failure" || "$value" == "cancelled" ]]; then
              echo "❌ ${name}: ${value}"
              fail=true
            fi
          done
          if [[ "$fail" == "true" ]]; then
            exit 1
          fi
          echo "✅ All remote compatibility tests passed or were skipped!"
