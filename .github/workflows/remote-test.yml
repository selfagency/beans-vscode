name: Remote Compatibility Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch: # Allow manual triggering

env:
  GO_VERSION: "1.23.5"
  BEANS_VERSION: "v0.13.2"

jobs:
  docker-remote-test:
    name: Docker Remote Test
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: ["20", "22"]
        base-image:
          - "node:20-alpine"
          - "node:22-bookworm"
          - "mcr.microsoft.com/devcontainers/typescript-node:22"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install

      - name: Compile extension
        run: pnpm run compile

      - name: Package extension
        run: |
          pnpm install -g @vscode/vsce
          # Use --no-dependencies to avoid pnpm/npm install conflicts in the
          # remote/docker test environment. The bundled extension already contains
          # all necessary code in dist/, so npm install is not needed during packaging.
          vsce package --no-dependencies --out beans-vscode-test.vsix

      - name: Create Dockerfile for testing
        run: |
          cat > Dockerfile.test << 'EOF'
          FROM ${{ matrix.base-image }}

          # Install Go from official source with architecture detection
          RUN ARCH=$(uname -m) && \
              if [ "$ARCH" = "x86_64" ]; then GOARCH="amd64"; \
              elif [ "$ARCH" = "aarch64" ]; then GOARCH="arm64"; \
              else echo "Unsupported architecture: $ARCH" && exit 1; fi && \
              if command -v apt-get > /dev/null; then \
                apt-get update && apt-get install -y curl jq git wget && \
                wget -q https://go.dev/dl/go${{ env.GO_VERSION }}.linux-${GOARCH}.tar.gz && \
                tar -C /usr/local -xzf go${{ env.GO_VERSION }}.linux-${GOARCH}.tar.gz && \
                rm go${{ env.GO_VERSION }}.linux-${GOARCH}.tar.gz; \
              elif command -v apk > /dev/null; then \
                apk add --no-cache curl jq git bash wget && \
                wget -q https://go.dev/dl/go${{ env.GO_VERSION }}.linux-${GOARCH}.tar.gz && \
                tar -C /usr/local -xzf go${{ env.GO_VERSION }}.linux-${GOARCH}.tar.gz && \
                rm go${{ env.GO_VERSION }}.linux-${GOARCH}.tar.gz; \
              fi

          ENV PATH="/usr/local/go/bin:/root/go/bin:${PATH}"

          # Install beans CLI (pinned version for reproducibility)
          RUN go install github.com/hmans/beans@${{ env.BEANS_VERSION }}

          # Verify beans installed
          RUN beans version

          # Set up workspace
          WORKDIR /workspace
          RUN git config --global user.email "test@example.com" && \
              git config --global user.name "Test User"

          # Copy extension for testing
          COPY . /workspace/

          EOF

      - name: Build test image
        run: docker build -t beans-vscode-remote-test -f Dockerfile.test .

      - name: Run remote compatibility tests
        run: |
          docker run --rm beans-vscode-remote-test /bin/bash -c '
            set -e

            echo "=== Testing Beans CLI ==="
            beans version

            echo ""
            echo "=== Initializing Beans workspace ==="
            beans init

            echo ""
            echo "=== Creating test beans ==="
            beans create "Test Issue 1" -t task -s todo -d "Test description"
            beans create "Test Bug" -t bug -s in-progress -p high
            beans create "Test Feature" -t feature -s draft

            echo ""
            echo "=== Listing beans ==="
            BEAN_COUNT=$(beans list --json | jq "length")
            echo "Found $BEAN_COUNT beans"

            if [ "$BEAN_COUNT" -ne 3 ]; then
              echo "ERROR: Expected 3 beans, found $BEAN_COUNT"
              exit 1
            fi

            echo ""
            echo "=== Testing bean operations ==="
            FIRST_BEAN=$(beans list --json | jq -r ".[0].id")
            echo "Testing with bean: $FIRST_BEAN"

            beans show "$FIRST_BEAN" --json | jq .
            beans update "$FIRST_BEAN" -s completed

            STATUS=$(beans show "$FIRST_BEAN" --json | jq -r ".status")
            if [ "$STATUS" != "completed" ]; then
              echo "ERROR: Bean status should be completed, got $STATUS"
              exit 1
            fi

            echo ""
            echo "=== Testing GraphQL query ==="
            beans query "{ beans { id title status type } }" --json | jq .

            echo ""
            echo "✅ All remote compatibility tests passed!"
          '

      - name: Upload test artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: remote-test-logs-${{ matrix.base-image }}-node${{ matrix.node-version }}
          path: |
            *.log
            .beans/

  devcontainer-test:
    name: Dev Container Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install

      - name: Compile extension
        run: pnpm run compile

      - name: Create test devcontainer config
        run: |
          mkdir -p .devcontainer-test
          cat > .devcontainer-test/devcontainer.json << EOF
          {
            "name": "Beans Remote Test",
            "image": "mcr.microsoft.com/devcontainers/typescript-node:22",
            "features": {
              "ghcr.io/devcontainers/features/go:1": {
                "version": "latest"
              }
            },
            "postCreateCommand": "go install github.com/hmans/beans@${{ env.BEANS_VERSION }} && beans init",
            "remoteEnv": {
              "PATH": "\${containerEnv:PATH}:/root/go/bin"
            },
            "customizations": {
              "vscode": {
                "settings": {
                  "beans.ai.enabled": true,
                  "beans.logging.level": "debug"
                }
              }
            }
          }
          EOF

      - name: Test devcontainer build
        uses: devcontainers/ci@v0.3
        with:
          configFile: .devcontainer-test/devcontainer.json
          runCmd: |
            echo "=== Checking beans installation ==="
            beans version

            echo ""
            echo "=== Verifying workspace initialized ==="
            if [ ! -f ".beans.yml" ]; then
              echo "ERROR: .beans.yml not found"
              exit 1
            fi

            echo ""
            echo "=== Creating and listing beans ==="
            beans create "DevContainer Test" -t task -s todo
            beans list --json | jq .

            echo ""
            echo "✅ DevContainer test passed!"

  # Optional: Test with actual VS Code in container
  vscode-integration-test:
    name: VS Code Remote Integration Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install

      - name: Compile and package
        run: |
          pnpm run compile
          pnpm install -g @vscode/vsce
          vsce package --no-dependencies

      - name: Verify extension package
        run: |
          echo "Extension packaged successfully for remote installation"
          ls -lh *.vsix
          
          # Verify the .vsix file was created
          if [ ! -f *.vsix ]; then
            echo "ERROR: Extension package not found"
            exit 1
          fi
          
          echo "✅ Extension can be packaged for remote deployment"

  summary:
    name: Remote Tests Summary
    runs-on: ubuntu-latest
    needs: [docker-remote-test, devcontainer-test, vscode-integration-test]
    if: always()

    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.docker-remote-test.result }}" != "success" ] || \
             [ "${{ needs.devcontainer-test.result }}" != "success" ] || \
             [ "${{ needs.vscode-integration-test.result }}" != "success" ]; then
            echo "❌ Some remote compatibility tests failed"
            exit 1
          fi
          echo "✅ All remote compatibility tests passed!"
