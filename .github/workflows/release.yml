name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  verify-ci:
    name: Verify CI checks for tag commit
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Validate required CI checks succeeded
        uses: actions/github-script@v8
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const sha = context.sha;

            const { data } = await github.rest.checks.listForRef({
              owner,
              repo,
              ref: sha,
              per_page: 100,
            });

            const runs = data.check_runs || [];
            const requiredPrefixes = [
              'Test on ',
              'Lint and Format Check',
              'Test Coverage',
            ];

            const failures = [];

            for (const prefix of requiredPrefixes) {
              const matching = runs.filter(run => run.name.startsWith(prefix));

              if (matching.length === 0) {
                failures.push(`Missing required check run(s) with prefix: ${prefix}`);
                continue;
              }

              const nonSuccess = matching.filter(
                run => run.status !== 'completed' || run.conclusion !== 'success'
              );

              if (nonSuccess.length > 0) {
                failures.push(
                  `Non-success required checks for prefix '${prefix}': ` +
                    nonSuccess.map(run => `${run.name}(${run.status}/${run.conclusion})`).join(', ')
                );
              }
            }

            if (failures.length > 0) {
              core.setFailed(
                `Release blocked: required CI checks did not pass for ${sha}.\n` + failures.join('\n')
              );
              return;
            }

            core.info(`All required CI checks are successful for ${sha}.`);

  release:
    name: Build and Release
    needs: verify-ci
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "22"

      - name: Install pnpm
        run: npm install -g pnpm@9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build extension package
        run: pnpm run package

      - name: Package extension
        run: |
          npm install -g @vscode/vsce
          vsce package --no-dependencies --out beans-vscode.vsix

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: "beans-vscode.vsix"
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to VS Code Marketplace
        if: "!contains(github.ref, '-')"
        run: vsce publish --packagePath beans-vscode.vsix -p ${{ secrets.VSCE_PAT }}
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}

      - name: Publish to Open VSX
        if: "!contains(github.ref, '-')"
        run: |
          npm install -g ovsx
          ovsx publish beans-vscode.vsix -p ${{ secrets.OVSX_PAT }}
        env:
          OVSX_PAT: ${{ secrets.OVSX_PAT }}
