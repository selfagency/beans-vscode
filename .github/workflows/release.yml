name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  verify-ci:
    name: Verify CI checks for tag commit
    runs-on: ubuntu-latest
    timeout-minutes: 40

    steps:
      - name: Validate required CI checks succeeded
        uses: actions/github-script@v8
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const sha = context.sha;

            const requiredPrefixes = [
              'Test on ',
              'Lint and Format Check',
              'Test Coverage',
            ];

            const failedConclusions = new Set([
              'failure',
              'cancelled',
              'timed_out',
              'action_required',
              'stale',
              'neutral',
              'skipped',
            ]);

            const maxAttempts = 120; // ~40 minutes at 20s intervals
            const delayMs = 20_000;

            for (let attempt = 1; attempt <= maxAttempts; attempt++) {
              const { data } = await github.rest.checks.listForRef({
                owner,
                repo,
                ref: sha,
                per_page: 100,
              });

              const runs = data.check_runs || [];
              const pending: string[] = [];
              const failures: string[] = [];

              for (const prefix of requiredPrefixes) {
                const matching = runs.filter(run => run.name.startsWith(prefix));

                if (matching.length === 0) {
                  pending.push(`Missing required check run(s) with prefix: ${prefix}`);
                  continue;
                }

                for (const run of matching) {
                  if (run.status !== 'completed') {
                    pending.push(`${run.name} is still ${run.status}`);
                    continue;
                  }

                  if (run.conclusion !== 'success') {
                    if (failedConclusions.has(run.conclusion || '')) {
                      failures.push(`${run.name} concluded with ${run.conclusion}`);
                    } else {
                      pending.push(`${run.name} concluded with ${run.conclusion}; waiting`);
                    }
                  }
                }
              }

              if (failures.length > 0) {
                core.setFailed(
                  `Release blocked: required CI checks failed for ${sha}.\n` + failures.join('\n')
                );
                return;
              }

              if (pending.length === 0) {
                core.info(`All required CI checks are successful for ${sha}.`);
                return;
              }

              core.info(
                `Attempt ${attempt}/${maxAttempts}: waiting for CI checks on ${sha}.\n` +
                  pending.join('\n')
              );

              await new Promise(resolve => setTimeout(resolve, delayMs));
            }

            core.setFailed(`Release blocked: timed out waiting for required CI checks on ${sha}.`);

  release:
    name: Build and Release
    needs: verify-ci
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "22"

      - name: Install pnpm
        run: npm install -g pnpm@9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build extension package
        run: pnpm run package

      - name: Package extension
        run: |
          npm install -g @vscode/vsce
          vsce package --no-dependencies --out beans-vscode.vsix

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: "beans-vscode.vsix"
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to VS Code Marketplace
        if: "!contains(github.ref, '-')"
        run: vsce publish --packagePath beans-vscode.vsix -p ${{ secrets.VSCE_PAT }}
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}

      - name: Publish to Open VSX
        if: "!contains(github.ref, '-')"
        run: |
          npm install -g ovsx
          ovsx publish beans-vscode.vsix -p ${{ secrets.OVSX_PAT }}
        env:
          OVSX_PAT: ${{ secrets.OVSX_PAT }}
