name: Release

on:
  push:
    tags: ["v*"]
  workflow_dispatch:

permissions:
  contents: read
  actions: read

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect-tag:
    name: Detect release tag and readiness
    runs-on: ubuntu-latest
    timeout-minutes: 5

    outputs:
      release_tag: ${{ steps.tag.outputs.release_tag }}
      ready: ${{ steps.tag.outputs.ready }}

    steps:
      - name: Resolve tag from successful workflow runs
        id: tag
        uses: actions/github-script@v8
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const tagName = context.ref.replace('refs/tags/', '');

            if (!tagName || !tagName.startsWith('v')) {
              core.info(`Ref '${context.ref}' is not a release tag; skipping.`);
              core.setOutput('release_tag', '');
              core.setOutput('ready', 'false');
              return;
            }

            const refData = await github.rest.git.getRef({
              owner,
              repo,
              ref: `tags/${tagName}`,
            });

            const taggedSha = refData.data.object.sha;
            const main = await github.rest.repos.getBranch({ owner, repo, branch: 'main' });
            const mainSha = main.data.commit.sha;

            if (taggedSha !== mainSha) {
              core.setFailed(
                `Release blocked: tag ${tagName} points to ${taggedSha}, but latest main is ${mainSha}.`
              );
              return;
            }

            const requiredWorkflows = ['CI', 'Remote Compatibility Tests'];
            const runs = await github.paginate(github.rest.actions.listWorkflowRunsForRepo, {
              owner,
              repo,
              branch: 'main',
              status: 'completed',
              per_page: 100,
            });

            for (const workflowName of requiredWorkflows) {
              const run = runs.find(r => r.name === workflowName && r.head_sha === mainSha);
              if (!run) {
                core.setFailed(
                  `Release blocked: required workflow '${workflowName}' has no completed run for ${mainSha}.`
                );
                return;
              }
              if (run.conclusion !== 'success') {
                core.setFailed(
                  `Release blocked: workflow '${workflowName}' concluded with '${run.conclusion}' on ${mainSha}.`
                );
                return;
              }
            }

            core.info(`Release tag detected: ${tagName} on latest main commit ${mainSha}; all checks passed.`);
            core.setOutput('release_tag', tagName);
            core.setOutput('ready', 'true');

  release:
    name: Build and Release
    needs: detect-tag
    if: needs.detect-tag.outputs.release_tag != '' && needs.detect-tag.outputs.ready == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.detect-tag.outputs.release_tag }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "22"

      - name: Install pnpm
        run: npm install -g pnpm@9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build extension package
        run: pnpm run package

      - name: Package extension
        run: |
          npm install -g @vscode/vsce
          vsce package --no-dependencies --out beans-vscode.vsix

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.detect-tag.outputs.release_tag }}
          files: "beans-vscode.vsix"
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to VS Code Marketplace
        if: "!contains(needs.detect-tag.outputs.release_tag, '-')"
        run: vsce publish --packagePath beans-vscode.vsix -p ${{ secrets.VSCE_PAT }}
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}

      - name: Publish to Open VSX
        if: "!contains(needs.detect-tag.outputs.release_tag, '-')"
        run: |
          npm install -g ovsx
          ovsx publish beans-vscode.vsix -p ${{ secrets.OVSX_PAT }}
        env:
          OVSX_PAT: ${{ secrets.OVSX_PAT }}
