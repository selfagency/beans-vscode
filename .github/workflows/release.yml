name: Release

on:
  workflow_run:
    workflows: ["CI", "Remote Compatibility Tests"]
    types: [completed]

permissions:
  contents: read
  actions: read

concurrency:
  group: release-${{ github.event.workflow_run.head_sha }}
  cancel-in-progress: false

jobs:
  detect-tag:
    name: Detect release tag and readiness
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 5

    outputs:
      release_tag: ${{ steps.tag.outputs.release_tag }}
      ready: ${{ steps.tag.outputs.ready }}

    steps:
      - name: Resolve tag from successful workflow runs
        id: tag
        uses: actions/github-script@v8
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const triggerRun = context.payload.workflow_run;
            const sha = triggerRun.head_sha;

            if (triggerRun.event !== 'push') {
              core.info(`Triggered by non-push event '${triggerRun.event}'; skipping release.`);
              core.setOutput('release_tag', '');
              core.setOutput('ready', 'false');
              return;
            }

            const tags = await github.paginate(github.rest.repos.listTags, {
              owner,
              repo,
              per_page: 100,
            });

            const match = tags.find(tag => tag.name.startsWith('v') && tag.commit?.sha === sha);

            if (!match) {
              core.info(`No release tag found for SHA ${sha}; skipping release.`);
              core.setOutput('release_tag', '');
              core.setOutput('ready', 'false');
              return;
            }

            const requiredWorkflows = ['CI', 'Remote Compatibility Tests'];
            const runs = await github.paginate(github.rest.actions.listWorkflowRunsForRepo, {
              owner,
              repo,
              event: 'push',
              status: 'completed',
              per_page: 100,
            });

            for (const workflowName of requiredWorkflows) {
              const run = runs.find(r => r.name === workflowName && r.head_sha === sha);

              if (!run) {
                core.info(`Waiting for workflow '${workflowName}' to complete for ${sha}.`);
                core.setOutput('release_tag', match.name);
                core.setOutput('ready', 'false');
                return;
              }

              const conclusion = run.conclusion;
              if (conclusion !== 'success') {
                core.setFailed(
                  `Release blocked: '${workflowName}' concluded with '${conclusion}' for ${sha}.`
                );
                return;
              }
            }

            core.info(`Release tag detected: ${match.name} for SHA ${sha}`);
            core.setOutput('release_tag', match.name);
            core.setOutput('ready', 'true');

  release:
    name: Build and Release
    needs: detect-tag
    if: needs.detect-tag.outputs.release_tag != '' && needs.detect-tag.outputs.ready == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.detect-tag.outputs.release_tag }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "22"

      - name: Install pnpm
        run: npm install -g pnpm@9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build extension package
        run: pnpm run package

      - name: Package extension
        run: |
          npm install -g @vscode/vsce
          vsce package --no-dependencies --out beans-vscode.vsix

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.detect-tag.outputs.release_tag }}
          files: "beans-vscode.vsix"
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to VS Code Marketplace
        if: "!contains(needs.detect-tag.outputs.release_tag, '-')"
        run: vsce publish --packagePath beans-vscode.vsix -p ${{ secrets.VSCE_PAT }}
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}

      - name: Publish to Open VSX
        if: "!contains(needs.detect-tag.outputs.release_tag, '-')"
        run: |
          npm install -g ovsx
          ovsx publish beans-vscode.vsix -p ${{ secrets.OVSX_PAT }}
        env:
          OVSX_PAT: ${{ secrets.OVSX_PAT }}
